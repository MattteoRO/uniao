{% extends 'base.html' %}

{% block title %}Cultural Brain Training - Game{% endblock %}

{% block content %}
<div class="game-container">
    <div class="row mb-3">
        <div class="col-md-6">
            <h2>Round {{ current_round }} of {{ total_rounds }}</h2>
        </div>
        <div class="col-md-6 text-end">
            <button id="next-question" class="btn btn-primary">Next Question</button>
        </div>
    </div>

    <div class="card bg-dark">
        <div class="card-body">
            <div id="question-container">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading question...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card bg-dark">
                <div class="card-header">
                    <h4>Players</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for player in players %}
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 bg-dark border-secondary">
                                <div class="card-body text-center">
                                    <h5 class="card-title">{{ player }}</h5>
                                    <p class="display-4 player-score" data-player="{{ player }}">{{ score[player] }}</p>
                                    <button class="btn btn-success answer-btn" data-player="{{ player }}" disabled>
                                        I know this!
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Answer Modal -->
<div class="modal fade" id="answerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Choose Answer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="player-name-display" class="mb-3 text-center"></h6>
                <div id="answer-options" class="d-grid gap-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Answer Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="result-icon" class="display-1 mb-3"></div>
                <h4 id="result-text" class="mb-3"></h4>
                <p id="result-explanation" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Game state
    let currentQuestion = null;
    let currentPlayerAnswering = null;
    let answerModalInstance = null;
    let resultModalInstance = null;
    
    // DOM elements
    const questionContainer = document.getElementById('question-container');
    const nextQuestionBtn = document.getElementById('next-question');
    const answerBtns = document.querySelectorAll('.answer-btn');
    const answerOptionsContainer = document.getElementById('answer-options');
    const playerNameDisplay = document.getElementById('player-name-display');
    
    // Modal elements
    const answerModal = document.getElementById('answerModal');
    const resultModal = document.getElementById('resultModal');
    const resultIcon = document.getElementById('result-icon');
    const resultText = document.getElementById('result-text');
    const resultExplanation = document.getElementById('result-explanation');
    
    // Initialize Bootstrap modals
    answerModalInstance = new bootstrap.Modal(answerModal);
    resultModalInstance = new bootstrap.Modal(resultModal);
    
    // Load first question on page load
    document.addEventListener('DOMContentLoaded', loadQuestion);
    
    // Event listeners
    nextQuestionBtn.addEventListener('click', loadQuestion);
    
    // Event listeners for answer buttons
    answerBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            currentPlayerAnswering = this.dataset.player;
            playerNameDisplay.textContent = currentPlayerAnswering;
            showAnswerOptions();
            answerModalInstance.show();
        });
    });
    
    // Load a new question from the server
    function loadQuestion() {
        // Disable the next question button while loading
        nextQuestionBtn.disabled = true;
        
        // Disable answer buttons
        answerBtns.forEach(btn => {
            btn.disabled = true;
        });
        
        // Show loading state
        questionContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading question...</p>
            </div>
        `;
        
        // Fetch new question from server
        fetch('{{ url_for("get_question") }}')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // Store current question data
                currentQuestion = data;
                
                // Display the question
                displayQuestion(data);
                
                // Enable answer buttons
                answerBtns.forEach(btn => {
                    btn.disabled = false;
                });
                
                // Enable next question button
                nextQuestionBtn.disabled = false;
            })
            .catch(error => {
                showError('Failed to load question. Please try again.');
                console.error(error);
            });
    }
    
    // Display the question in the container
    function displayQuestion(question) {
        let imageHtml = '';
        if (question.image_url) {
            imageHtml = `<img src="${question.image_url}" alt="Question image" class="img-fluid mb-3 rounded">`;
        }
        
        questionContainer.innerHTML = `
            <div class="text-center">
                <span class="badge bg-secondary mb-2">${question.category.toUpperCase()}</span>
                <span class="badge bg-info mb-2">${question.culture || 'World Culture'}</span>
            </div>
            <h3 class="text-center mb-4">${question.question}</h3>
            ${imageHtml}
        `;
    }
    
    // Display answer options in the modal
    function showAnswerOptions() {
        if (!currentQuestion) return;
        
        answerOptionsContainer.innerHTML = '';
        
        currentQuestion.options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'btn btn-outline-primary btn-lg mb-2';
            button.textContent = option;
            button.addEventListener('click', () => {
                checkAnswer(option);
            });
            answerOptionsContainer.appendChild(button);
        });
    }
    
    // Check if the selected answer is correct
    function checkAnswer(selectedAnswer) {
        const isCorrect = selectedAnswer === currentQuestion.correct_answer;
        
        // Close the answer modal
        answerModalInstance.hide();
        
        // Send result to server
        fetch('{{ url_for("submit_answer") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                player: currentPlayerAnswering,
                correct: isCorrect
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.updated_score) {
                // Update score displays
                for (const [player, score] of Object.entries(data.updated_score)) {
                    const scoreEl = document.querySelector(`.player-score[data-player="${player}"]`);
                    if (scoreEl) {
                        scoreEl.textContent = score;
                    }
                }
            }
        });
        
        // Show result modal
        if (isCorrect) {
            resultIcon.innerHTML = '✅';
            resultText.textContent = 'Correct!';
        } else {
            resultIcon.innerHTML = '❌';
            resultText.textContent = `Wrong! The correct answer is: ${currentQuestion.correct_answer}`;
        }
        
        resultExplanation.textContent = currentQuestion.explanation || '';
        resultModalInstance.show();
    }
    
    // Display error message
    function showError(message) {
        questionContainer.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <p>${message}</p>
                <button class="btn btn-primary" onclick="loadQuestion()">Try Again</button>
            </div>
        `;
    }
</script>
{% endblock %}